<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Board Game Score Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/000000/ffffff?text=BGS">
    <!-- Meta tags for iOS PWA behavior -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1f2937">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #e5e7eb;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.7);
        }
        .loader {
            border-top-color: #3b82f6;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @-webkit-keyframes spinner {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .player-list-item.dragging {
            opacity: 0.5;
            background: #4b5563;
        }
        .drag-over {
            border-top: 2px solid #3b82f6;
        }
    </style>
</head>
<body class="antialiased">
    
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex flex-col items-center justify-center z-50">
        <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32 mb-4"></div>
        <h2 id="loading-message" class="text-center text-white text-xl font-semibold">Connecting...</h2>
        <p class="w-1/2 text-center text-white mt-2">Getting things ready for your game night.</p>
    </div>

    <div id="app" class="container mx-auto p-4 max-w-4xl">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-bold text-white">Board Game Score Tracker</h1>
            <p class="text-gray-400">Manage your game nights with ease.</p>
        </header>

        <main id="main-content">
            <div id="setup-screen" class="space-y-6">
                <!-- Join Game -->
                <div>
                    <h2 class="text-2xl font-semibold mb-3 text-white">Join a Game Night</h2>
                    <div class="bg-gray-800 p-4 rounded-lg flex items-center gap-4">
                        <input type="number" id="join-code-input" placeholder="Enter 4-digit code" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white text-center tracking-widest">
                        <button id="join-game-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-6 rounded-md transition">Join</button>
                    </div>
                </div>

                <div class="text-center text-gray-400 font-bold">OR</div>

                <!-- Create Game -->
                <div>
                    <button id="create-game-night-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-extrabold py-3 px-4 rounded-lg text-lg transition duration-300 transform hover:scale-105">Create a Game Night</button>
                </div>
            </div>

            <div id="lobby-screen" class="hidden">
                <div class="bg-gray-800 p-4 rounded-lg mb-6 text-center">
                    <p class="text-lg text-gray-400">Game Night In Progress</p>
                    <p class="text-sm uppercase text-indigo-400 font-bold">Invite Code</p>
                    <p id="lobby-invite-code" class="text-5xl font-mono font-bold tracking-widest"></p>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg mb-6">
                    <h3 class="text-2xl font-bold mb-3">Connected Devices</h3>
                    <div id="lobby-participant-list" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <!-- JS will populate this -->
                    </div>
                </div>
                <div class="space-y-6">
                     <h2 class="text-2xl font-semibold text-white">Game Setup</h2>
                     <div class="bg-gray-900 p-4 rounded-lg space-y-4">
                        <h3 class="text-xl font-semibold">1. Select a Game</h3>
                        <select id="lobby-game-select" class="w-full bg-gray-700 rounded-md p-2 text-white"></select>
                    
                        <h3 class="text-xl font-semibold">2. Select Players for this Game</h3>
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="w-full md:w-1/2">
                                <h4 class="font-semibold mb-2 text-gray-300">Add a Player</h4>
                                <select id="lobby-available-players-select" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white"></select>
                            </div>
                            <div class="w-full md:w-1/2">
                                <h4 class="font-semibold mb-2 text-gray-300">Selected Players (Drag to Reorder)</h4>
                                <div id="lobby-selected-players" class="space-y-2 max-h-48 overflow-y-auto p-2 bg-gray-800 rounded-md border border-gray-700"></div>
                            </div>
                        </div>
                     </div>
                    <button id="lobby-start-game-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 text-lg rounded-md disabled:bg-gray-500 disabled:cursor-not-allowed">Start Game</button>
                </div>
                <div class="mt-6 border-t border-gray-700 pt-6">
                    <h3 class="text-xl font-semibold mb-3 text-center">Session Options</h3>
                    <div class="flex flex-wrap justify-center gap-4">
                        <button class="open-manage-players-modal w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">Manage My Players</button>
                        <button class="open-manage-games-modal w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">Manage My Games</button>
                        <button id="view-leaderboard-btn" class="w-full sm:w-auto bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">King of the Session</button>
                        <button id="leave-session-btn" class="w-full sm:w-auto bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">Leave Game Night</button>
                    </div>
                </div>
            </div>


            <div id="game-screen" class="hidden">
                <div class="bg-gray-800 p-4 rounded-lg mb-4">
                     <div class="flex justify-between items-start mb-3">
                        <h2 id="game-title-display" class="text-3xl font-bold"></h2>
                        <div class="text-center bg-indigo-600 p-2 rounded-lg">
                            <p class="text-xs uppercase font-bold text-indigo-200">Invite Code</p>
                            <p id="game-code-display" class="text-2xl font-bold font-mono"></p>
                        </div>
                    </div>
                    <div class="flex justify-around items-center text-center border-t border-gray-700 pt-3">
                        <div><p id="target-score-label" class="text-sm uppercase text-gray-400">Target Score</p><p id="target-score-display" class="text-2xl font-bold text-amber-400"></p></div>
                        <div><p class="text-sm uppercase text-gray-400">Current Round</p><p id="round-counter" class="text-2xl font-bold">1</p></div>
                        <div><p class="text-sm uppercase text-gray-400">Time Elapsed</p><p id="timer" class="text-2xl font-bold font-mono">00:00:00</p></div>
                    </div>
                </div>
                <div id="scoreboard" class="space-y-3"></div>
                <div id="game-controls" class="mt-6 flex flex-col sm:flex-row gap-3">
                    <button id="end-round-btn" class="w-full sm:w-1/2 bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 px-4 rounded-md transition duration-300">End Current Round</button>
                    <button id="end-game-early-btn" class="w-full sm:w-1/2 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">End Game Early</button>
                </div>
            </div>
        </main>

        <div id="manage-games-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4">
             <div class="bg-gray-800 w-full max-w-md rounded-lg shadow-xl p-6">
                <h3 class="text-2xl font-bold mb-4 text-white">Manage My Games</h3>
                 <div id="game-list" class="space-y-2 mb-4 max-h-40 overflow-y-auto"></div>
                
                 <div class="space-y-4 border-t border-gray-700 pt-4">
                     <textarea id="game-rules-input" placeholder="Paste game rules here to analyze..." class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white h-24"></textarea>
                     <button id="analyze-rules-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-md relative">
                        Analyze Rules
                        <div id="analyze-loader" class="hidden absolute right-4 top-1/2 -translate-y-1/2 loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6"></div>
                    </button>
                 </div>

                <div class="space-y-4 border-t border-gray-700 pt-4 mt-4">
                    <h4 class="text-lg font-semibold">Or Add Manually:</h4>
                    <input type="text" id="game-name-input" placeholder="Game Name" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white">
                    <div>
                        <label id="score-input-label" for="game-score-input" class="block text-sm font-medium text-gray-300 mb-1">Winning Score</label>
                        <input type="number" id="game-score-input" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white">
                    </div>
                    <select id="game-condition-select" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white">
                        <option value="highest">Highest Score Wins</option>
                        <option value="lowest">Lowest Score Wins</option>
                        <option value="bestOf">Best of (Tickets)</option>
                    </select>
                    <div class="flex items-center"><input type="checkbox" id="final-round-mode-checkbox" class="h-4 w-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500"><label for="final-round-mode-checkbox" class="ml-2 text-white">Final Round Mode</label></div>
                </div>
                <div class="mt-6 flex justify-between"><button id="save-game-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Add Game</button><button id="close-games-modal-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">Close</button></div>
            </div>
        </div>
        <div id="manage-players-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4">
            <div class="bg-gray-800 w-full max-w-md rounded-lg shadow-xl p-6">
                 <h3 class="text-2xl font-bold mb-4 text-white">Manage My Players</h3>
                 <div id="player-list" class="space-y-2 mb-4 max-h-60 overflow-y-auto"></div>
                 <div class="flex gap-2"><input type="text" id="player-name-input" placeholder="Player Name" class="flex-grow bg-gray-700 border border-gray-600 rounded-md p-2 text-white"><button id="add-player-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Add</button></div>
                 <div class="mt-6 text-right"><button id="close-players-modal-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">Close</button></div>
            </div>
        </div>
        <div id="leaderboard-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4">
            <div class="bg-gray-800 w-full max-w-lg rounded-lg shadow-xl p-6">
                <h3 class="text-2xl font-bold mb-4 text-white">King of the Session</h3>
                <div id="session-leaderboard-content" class="max-h-96 overflow-y-auto"></div>
                <div class="mt-6 flex justify-between items-center"><button id="new-session-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">New Session</button><button id="close-leaderboard-modal-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">Close</button></div>
            </div>
        </div>
        <div id="end-game-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4">
            <div class="bg-gray-800 w-full max-w-md rounded-lg shadow-xl p-6 text-center">
                <h3 id="end-game-title" class="text-3xl font-bold mb-4 text-white">Game Over!</h3><div id="final-scores" class="space-y-2 mb-6"></div>
                <button id="return-to-lobby-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">Back to Lobby</button>
            </div>
        </div>
    </div>
    <div id="notification" class="fixed bottom-5 right-5 bg-red-600 text-white py-3 px-5 rounded-lg shadow-lg opacity-0 transition-opacity duration-500 z-50"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, addDoc, getDoc, deleteDoc, onSnapshot, updateDoc, increment, setDoc, arrayUnion, arrayRemove, writeBatch, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDlB0PII1L5M8ojUXXsQ5kkJB8jUACkyK0",
            authDomain: "gametracker-45957.firebaseapp.com",
            projectId: "gametracker-45957",
            storageBucket: "gametracker-45957.appspot.com",
            messagingSenderId: "960845458759",
            appId: "1:960845458759:web:9b0e89be74d09910337062"
        };

        const appId = 'gametracker-45957'; // Using your projectId as a default app ID
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('debug');

        let userId;
        let unsubscribeSession = null; 

        // DOM Elements
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingMessage = document.getElementById('loading-message');
        const notification = document.getElementById('notification');
        const setupScreen = document.getElementById('setup-screen');
        const lobbyScreen = document.getElementById('lobby-screen');
        const gameScreen = document.getElementById('game-screen');
        const gameControls = document.getElementById('game-controls');
        const guestView = document.getElementById('guest-view');
        const createGameNightBtn = document.getElementById('create-game-night-btn');
        const joinGameBtn = document.getElementById('join-game-btn');
        const joinCodeInput = document.getElementById('join-code-input');
        const lobbyInviteCode = document.getElementById('lobby-invite-code');
        const lobbyParticipantList = document.getElementById('lobby-participant-list');
        const lobbyGameSelect = document.getElementById('lobby-game-select');
        const lobbyAvailablePlayersSelect = document.getElementById('lobby-available-players-select');
        const lobbySelectedPlayers = document.getElementById('lobby-selected-players');
        const lobbyStartGameBtn = document.getElementById('lobby-start-game-btn');
        const leaveSessionBtn = document.getElementById('leave-session-btn');
        const manageGamesModal = document.getElementById('manage-games-modal');
        const managePlayersModal = document.getElementById('manage-players-modal');
        const leaderboardModal = document.getElementById('leaderboard-modal');
        const endGameModal = document.getElementById('end-game-modal');
        const closeGamesModalBtn = document.getElementById('close-games-modal-btn');
        const closePlayersModalBtn = document.getElementById('close-players-modal-btn');
        const viewLeaderboardBtn = document.getElementById('view-leaderboard-btn');
        const closeLeaderboardModalBtn = document.getElementById('close-leaderboard-modal-btn');
        const newSessionBtn = document.getElementById('new-session-btn');
        const gameList = document.getElementById('game-list');
        const saveGameBtn = document.getElementById('save-game-btn');
        const gameNameInput = document.getElementById('game-name-input');
        const gameScoreInput = document.getElementById('game-score-input');
        const scoreInputLabel = document.getElementById('score-input-label');
        const gameConditionSelect = document.getElementById('game-condition-select');
        const finalRoundModeCheckbox = document.getElementById('final-round-mode-checkbox');
        const gameRulesInput = document.getElementById('game-rules-input');
        const analyzeRulesBtn = document.getElementById('analyze-rules-btn');
        const analyzeLoader = document.getElementById('analyze-loader');
        const playerList = document.getElementById('player-list');
        const addPlayerBtn = document.getElementById('add-player-btn');
        const playerNameInput = document.getElementById('player-name-input');
        const endRoundBtn = document.getElementById('end-round-btn');
        const endGameEarlyBtn = document.getElementById('end-game-early-btn');
        const returnToLobbyBtn = document.getElementById('return-to-lobby-btn');
        const roundCounter = document.getElementById('round-counter');
        const timerDisplay = document.getElementById('timer');
        const targetScoreDisplay = document.getElementById('target-score-display');
        const targetScoreLabel = document.getElementById('target-score-label');
        const gameTitleDisplay = document.getElementById('game-title-display');
        const gameCodeDisplay = document.getElementById('game-code-display');
        const finalScores = document.getElementById('final-scores');
        const endGameTitle = document.getElementById('end-game-title');
        const sessionLeaderboardContent = document.getElementById('session-leaderboard-content');

        // App State
        let state = {
            games: [], players: [],
            currentGame: null, gameState: null, 
            timerInterval: null, startTime: null,
            sessionStats: { totalWins: {}, gameWins: {} },
            currentSession: null, 
        };
        
        let gamesCollection, playersCollection, sessionsCollection;
        let authReady = false;

        // --- Authentication ---
        const connectionTimeout = setTimeout(() => {
            if (!authReady) {
                loadingMessage.textContent = "Connection Failed";
                document.querySelector('#loading-overlay .loader').classList.add('hidden');
                showNotification("Could not connect. Please check your network and refresh.", true, 10000);
            }
        }, 10000); // 10-second timeout

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                if (!authReady) {
                    authReady = true;
                    clearTimeout(connectionTimeout);
                    userId = user.uid;
                    initApp();
                }
            } else {
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Anonymous sign-in failed:", error);
                    clearTimeout(connectionTimeout);
                    loadingOverlay.classList.add('hidden');
                    showNotification("Could not connect to the database. Some features might be unavailable.", true);
                }
            }
        });

        // --- Initialization ---
        function initApp() {
            if (!userId) {
                showNotification("Authentication failed. Cannot load data.", true);
                loadingOverlay.classList.add('hidden');
                return;
            }
            try {
                gamesCollection = collection(db, `artifacts/${appId}/users/${userId}/games`);
                playersCollection = collection(db, `artifacts/${appId}/users/${userId}/players`);
                sessionsCollection = collection(db, `artifacts/${appId}/public/data/sessions`);
                setupEventListeners();
                loadInitialData();
                loadingOverlay.classList.add('hidden');
            } catch (error) {
                console.error("Initialization failed: ", error);
                loadingOverlay.classList.add('hidden');
                showNotification("An error occurred loading the app.", true);
            }
        }

        async function loadInitialData() {
            onSnapshot(gamesCollection, (snapshot) => {
                state.games = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderGameList();
                renderLobbyGameSelect();
            }, (error) => { console.error("Error loading games:", error); showNotification("Could not load games.", true); });

            onSnapshot(playersCollection, (snapshot) => {
                state.players = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPlayerList();
                 if (!lobbyScreen.classList.contains('hidden')) {
                    renderLobbyPlayerSelection();
                }
            }, (error) => { console.error("Error loading players:", error); showNotification("Could not load players.", true); });
        }
        
        function setupEventListeners() {
            document.querySelectorAll('.open-manage-games-modal').forEach(btn => btn.addEventListener('click', () => manageGamesModal.classList.remove('hidden')));
            document.querySelectorAll('.open-manage-players-modal').forEach(btn => btn.addEventListener('click', () => managePlayersModal.classList.remove('hidden')));
            closeGamesModalBtn.addEventListener('click', () => manageGamesModal.classList.add('hidden'));
            saveGameBtn.addEventListener('click', saveGame);
            closePlayersModalBtn.addEventListener('click', () => managePlayersModal.classList.add('hidden'));
            addPlayerBtn.addEventListener('click', addPlayer);
            analyzeRulesBtn.addEventListener('click', analyzeGameRules);
            viewLeaderboardBtn.addEventListener('click', () => { renderSessionLeaderboard(); leaderboardModal.classList.remove('hidden'); });
            closeLeaderboardModalBtn.addEventListener('click', () => leaderboardModal.classList.add('hidden'));
            newSessionBtn.addEventListener('click', startNewSession);
            createGameNightBtn.addEventListener('click', createGameNight);
            joinGameBtn.addEventListener('click', joinGameSession);
            leaveSessionBtn.addEventListener('click', leaveSession);
            lobbyStartGameBtn.addEventListener('click', startGame);
            endRoundBtn.addEventListener('click', endRound);
            endGameEarlyBtn.addEventListener('click', () => updateSession({ "currentGame.isFinished": true }));
            returnToLobbyBtn.addEventListener('click', () => {
                 updateSession({ currentGame: null });
            });
            lobbyGameSelect.addEventListener('change', (e) => updateSession({ selectedGameId: e.target.value }));
            lobbyAvailablePlayersSelect.addEventListener('change', (e) => {
                const playerId = e.target.value;
                if(playerId) {
                    updateSession({ lobbySelectedPlayerIds: arrayUnion(playerId) });
                    e.target.value = ""; // Reset dropdown
                }
            });
            // Touch and Mouse Drag Events
            lobbySelectedPlayers.addEventListener('dragstart', handleDragStart);
            lobbySelectedPlayers.addEventListener('dragend', handleDragEnd);
            lobbySelectedPlayers.addEventListener('dragover', handleDragOver);
            lobbySelectedPlayers.addEventListener('drop', handleDrop);
            lobbySelectedPlayers.addEventListener('touchstart', handleTouchStart, { passive: false });
            lobbySelectedPlayers.addEventListener('touchmove', handleTouchMove, { passive: false });
            lobbySelectedPlayers.addEventListener('touchend', handleTouchEnd);
            gameConditionSelect.addEventListener('change', (e) => {
                scoreInputLabel.textContent = e.target.value === 'bestOf' ? "Number of Tickets" : "Winning Score";
            });
        }
        
        function renderLobbyGameSelect() {
            lobbyGameSelect.innerHTML = '<option value="">-- Select a Game to Play --</option>';
            state.games.forEach(game => {
                const option = document.createElement('option');
                option.value = game.id;
                option.textContent = game.name;
                lobbyGameSelect.appendChild(option);
            });
            if (state.currentSession) {
                lobbyGameSelect.value = state.currentSession.selectedGameId || "";
            }
        }

        function renderGameList() {
            gameList.innerHTML = '';
            if (state.games.length === 0) gameList.innerHTML = `<p class="text-gray-400">No games added yet.</p>`;
            else state.games.forEach(game => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-gray-700 p-2 rounded-md';
                div.innerHTML = `<span>${game.name} (${game.winningScore} pts)</span><button data-id="${game.id}" class="delete-game-btn bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded">Delete</button>`;
                gameList.appendChild(div);
            });
            document.querySelectorAll('.delete-game-btn').forEach(btn => btn.addEventListener('click', (e) => deleteGame(e.target.dataset.id)));
        }

        function renderPlayerList() {
            playerList.innerHTML = '';
            if (state.players.length === 0) playerList.innerHTML = `<p class="text-gray-400">No players added yet.</p>`;
            else state.players.forEach(player => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-gray-700 p-2 rounded-md';
                div.innerHTML = `<span>${player.name}</span><button data-id="${player.id}" class="delete-player-btn bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded">Delete</button>`;
                playerList.appendChild(div);
            });
            document.querySelectorAll('.delete-player-btn').forEach(btn => btn.addEventListener('click', (e) => deletePlayer(e.target.dataset.id)));
        }

        function renderLobby() {
            if (!state.currentSession) return;
            lobbyInviteCode.textContent = state.currentSession.id;
            
            lobbyParticipantList.innerHTML = '';
            state.currentSession.participants.forEach(p => {
                const div = document.createElement('div');
                div.className = 'bg-gray-700 p-3 rounded-md text-center';
                div.innerHTML = `<p class="font-semibold truncate">${p.userId.substring(0, 8)}...</p>${p.userId === state.currentSession.hostId ? '<p class="text-xs text-indigo-400 font-bold">HOST</p>' : ''}`;
                lobbyParticipantList.appendChild(div);
            });
            renderLobbyPlayerSelection();
            renderLobbyGameSelect();
        }

        function renderLobbyPlayerSelection() {
            const selectedIds = state.currentSession?.lobbySelectedPlayerIds || [];
            const available = state.players.filter(p => !selectedIds.includes(p.id));
            lobbyAvailablePlayersSelect.innerHTML = '<option value="">-- Add a Player --</option>';
            available.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.name;
                lobbyAvailablePlayersSelect.appendChild(option);
            });

            lobbySelectedPlayers.innerHTML = '';
            selectedIds.forEach(id => {
                const player = state.players.find(p => p.id === id);
                if (player) {
                    const div = createPlayerListItem(player, true);
                    div.onclick = () => { updateSession({ lobbySelectedPlayerIds: arrayRemove(id) }); };
                    lobbySelectedPlayers.appendChild(div);
                }
            });
        }
        
        function createPlayerListItem(player, isSelected) {
            const div = document.createElement('div');
            div.dataset.id = player.id;
            div.className = 'player-list-item p-2 rounded-md cursor-pointer transition-all flex items-center justify-between';
            if (isSelected) {
                div.classList.add('bg-blue-600', 'hover:bg-blue-700', 'text-white');
                div.draggable = true;
                div.innerHTML = `<span>${player.name}</span> <span class="text-gray-300">â˜°</span>`;
            } else {
                div.classList.add('bg-gray-700', 'hover:bg-gray-600');
                div.textContent = player.name;
            }
            return div;
        }

        function updateUIBasedOnState(sessionData) {
            state.currentSession = sessionData;
            if (sessionData.currentGame) {
                setupScreen.classList.add('hidden');
                lobbyScreen.classList.add('hidden');
                gameScreen.classList.remove('hidden');
                renderGameState(sessionData.currentGame);
            } else {
                setupScreen.classList.add('hidden');
                gameScreen.classList.add('hidden');
                lobbyScreen.classList.remove('hidden');
                renderLobby();
            }
        }
        
        function renderGameState(gameState) {
            state.gameState = gameState;
            const gameInfo = gameState;
            if (!gameInfo || !gameInfo.name) { showNotification("Game data is incomplete!"); leaveSession(); return; }
            state.currentGame = gameInfo; 
            targetScoreLabel.textContent = gameInfo.condition === 'bestOf' ? "Total Tickets" : "Target Score";
            targetScoreDisplay.textContent = `${gameInfo.winningScore} ${gameInfo.condition === 'bestOf' ? 'Tickets' : 'pts'}`;
            gameTitleDisplay.textContent = gameInfo.name;
            roundCounter.textContent = gameState.round;
            gameCodeDisplay.textContent = state.currentSession.id;
            if (!state.timerInterval && gameState.startTime) {
                state.startTime = gameState.startTime;
                startTimer();
            }
            renderScoreboard();
            if (gameState.isFinished) {
                triggerEndGame("Game Over");
            }
        }

        function renderScoreboard() {
            if (!state.gameState || !Array.isArray(state.gameState.players)) return;
            gameControls.classList.toggle('hidden', state.currentGame.condition === 'bestOf');
            scoreboard.innerHTML = '';
            state.gameState.players.forEach(player => {
                const playerInfo = state.players.find(p => p.id === player.id);
                if (!playerInfo) return;
                const div = document.createElement('div');
                div.className = 'p-4 rounded-lg flex items-center justify-between bg-gray-800 shadow-md';
                const mainScoreLabel = state.currentGame.condition === 'bestOf' ? 'Tickets' : 'Score';
                let controlsHTML = '';
                if(state.currentGame.condition === 'bestOf') {
                    controlsHTML = `<button data-id="${player.id}" class="won-round-btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Declare Winner</button>`;
                } else {
                    controlsHTML = `<input type="number" data-id="${player.id}" class="score-input w-20 text-center bg-gray-700 border border-gray-600 rounded-md p-2 text-white" placeholder="Round Pts"><button data-id="${player.id}" class="add-score-btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-md text-lg">+</button><button data-id="${player.id}" class="zero-score-btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-md">0</button>`;
                }
                div.innerHTML = `<div><p class="text-xl font-semibold">${playerInfo.name}</p><p class="text-3xl font-bold">${player.score} <span class="text-base font-normal">${mainScoreLabel}</span></p></div><div class="flex items-center gap-2">${controlsHTML}</div>`;
                scoreboard.appendChild(div);
            });
            document.querySelectorAll('.add-score-btn').forEach(btn => btn.addEventListener('click', (e) => { const playerId = e.target.dataset.id; const input = document.querySelector(`.score-input[data-id="${playerId}"]`); if (input.value !== '') { addScore(playerId, parseInt(input.value, 10)); input.value = ''; } }));
            document.querySelectorAll('.zero-score-btn').forEach(btn => btn.addEventListener('click', (e) => addScore(e.target.dataset.id, 0)));
            document.querySelectorAll('.won-round-btn').forEach(btn => btn.addEventListener('click', (e) => awardTicket(e.target.dataset.id)));
        }

        function renderSessionLeaderboard() {
            sessionLeaderboardContent.innerHTML = '';
            const kingOfTheHillBanner = document.createElement('div');
            kingOfTheHillBanner.className = 'p-4 bg-gradient-to-br from-amber-400 to-yellow-500 text-black rounded-lg mb-6 text-center shadow-lg';
            const sessionTotalWins = Object.entries(state.sessionStats.totalWins);
            if (sessionTotalWins.length > 0) {
                sessionTotalWins.sort(([, a], [, b]) => b - a);
                const topWins = sessionTotalWins[0][1];
                const kings = sessionTotalWins.filter(([, wins]) => wins === topWins);
                const kingNames = kings.map(([playerId,]) => state.players.find(p => p.id === playerId)?.name || 'Unknown').join(' & ');
                kingOfTheHillBanner.innerHTML = `<h4 class="text-sm uppercase font-bold tracking-widest">King of the Session</h4><p class="text-4xl font-extrabold text-white text-shadow-md">${kingNames} ðŸ‘‘</p><p class="text-lg font-semibold">${topWins} Total Wins</p>`;
            } else {
                kingOfTheHillBanner.innerHTML = `<h4 class="text-sm uppercase font-bold tracking-wider">King of the Session</h4><p class="text-2xl font-bold">The Throne is Empty!</p><p class="text-sm">Play a game to crown a winner.</p>`;
            }
            sessionLeaderboardContent.appendChild(kingOfTheHillBanner);
            const gameKingsList = document.createElement('div');
            gameKingsList.className = 'space-y-4';
            const sessionGameWins = Object.entries(state.sessionStats.gameWins);
            if (sessionGameWins.length === 0) {
                 gameKingsList.innerHTML = `<p class="text-center text-gray-400">No specific game champions yet.</p>`;
            } else {
                const subheader = document.createElement('h5');
                subheader.className = 'text-lg font-bold text-center text-gray-300 border-b border-gray-600 pb-2 mb-4';
                subheader.textContent = 'Game Championships';
                gameKingsList.appendChild(subheader);
                sessionGameWins.forEach(([gameId, playerWins]) => {
                    const game = state.games.find(g => g.id === gameId);
                    const winCounts = Object.entries(playerWins).sort(([, a], [, b]) => b - a);
                    if (winCounts.length > 0) {
                        const topWins = winCounts[0][1];
                        const gameKings = winCounts.filter(([, wins]) => wins === topWins);
                        const kingNames = gameKings.map(([playerId,]) => state.players.find(p => p.id === playerId)?.name || 'Unknown').join(' & ');
                        const gameKingItem = document.createElement('div');
                        gameKingItem.className = 'p-3 bg-gradient-to-br from-gray-500 to-gray-600 text-white rounded-lg shadow-md flex justify-between items-center';
                        gameKingItem.innerHTML = `<div><p class="text-sm uppercase font-semibold text-gray-300">Champion of ${game.name}</p><p class="font-bold text-xl">${kingNames}</p></div><p class="font-bold text-2xl">${topWins} Wins</p>`;
                        gameKingsList.appendChild(gameKingItem);
                    }
                });
            }
            sessionLeaderboardContent.appendChild(gameKingsList);
        }
        
        async function createGameNight() {
            let newCode;
            let codeExists = true;
            while(codeExists) {
                newCode = Math.floor(1000 + Math.random() * 9000).toString();
                const docSnap = await getDoc(doc(sessionsCollection, newCode));
                codeExists = docSnap.exists();
            }
            await setDoc(doc(sessionsCollection, newCode), {
                hostId: userId,
                participants: [{userId}],
                currentGame: null,
                createdAt: Date.now(),
                selectedGameId: null,
                lobbySelectedPlayerIds: [],
            });
            subscribeToSession(newCode);
        }

        async function joinGameSession() {
            const code = joinCodeInput.value;
            if (code.length !== 4) { showNotification("Code must be 4 digits.", true); return; }
            const sessionRef = doc(sessionsCollection, code);
            const docSnap = await getDoc(sessionRef);

            if (docSnap.exists()) {
                await updateDoc(sessionRef, { participants: arrayUnion({userId}) });
                subscribeToSession(code);
            } else {
                showNotification("Game session not found.", true);
            }
        }

        function subscribeToSession(sessionId) {
            state.currentSessionId = sessionId;
            if (unsubscribeSession) unsubscribeSession();
            unsubscribeSession = onSnapshot(doc(sessionsCollection, sessionId), (doc) => {
                if(doc.exists()) {
                    updateUIBasedOnState({ id: doc.id, ...doc.data() });
                } else {
                    showNotification("Game session has ended.", false);
                    resetApp();
                }
            });
        }
        
        async function leaveSession() {
            if (!state.currentSession) return;
            const sessionRef = doc(sessionsCollection, state.currentSession.id);
            const playerProfile = state.currentSession.participants.find(p => p.userId === userId);
            
            if (state.currentSession.hostId === userId && state.currentSession.participants.length > 1) {
                showNotification("Host can't leave a session with other players.", true);
                return;
            } else if(state.currentSession.hostId === userId) {
                 await deleteDoc(sessionRef);
            } else {
                await updateDoc(sessionRef, { participants: arrayRemove(playerProfile) });
            }
            resetApp();
        }

        function addScore(playerId, score) {
            if (!state.gameState || !Array.isArray(state.gameState.players)) return;
            const playerIndex = state.gameState.players.findIndex(p => p.id === playerId);
            if (playerIndex > -1 && !isNaN(score)) {
                let newPlayers = JSON.parse(JSON.stringify(state.gameState.players));
                let player = newPlayers[playerIndex];
                player.roundScores[state.gameState.round] = score;
                if (state.currentSession.currentGame.condition !== 'bestOf') {
                    player.score += score;
                }
                updateSession({ [`currentGame.players`]: newPlayers }).then(() => {
                    const allScoresIn = newPlayers.every(p => p.roundScores[state.gameState.round] !== undefined);
                    if (allScoresIn) endRound();
                });
            }
        }

        function awardTicket(winnerId) {
            if (!state.gameState || !Array.isArray(state.gameState.players)) return;
            let newPlayers = JSON.parse(JSON.stringify(state.gameState.players));
            const playerIndex = newPlayers.findIndex(p => p.id === winnerId);
            if (playerIndex > -1) {
                newPlayers[playerIndex].score += 1;
                newPlayers.forEach(p => p.roundScores[state.gameState.round] = p.id === winnerId ? 1 : 0);
                
                const updates = {
                    [`currentGame.players`]: newPlayers,
                    [`currentGame.round`]: increment(1)
                };
                updateSession(updates).then(() => checkForWinner());
            }
        }
        
        async function endRound() {
            if (state.currentSession.currentGame.condition === 'bestOf') return;
            await updateSession({ [`currentGame.round`]: increment(1) });
            checkForWinner();
        }

        async function checkForWinner() {
            if (!state.currentSession.currentGame || !Array.isArray(state.currentSession.currentGame.players)) return;
            let updates = {};
            const { players, winningScore, condition, finalRoundMode, isFinalPhase: currentIsFinalPhase, potentialWinnerStreak: currentStreak, lastRoundLeaderId: currentLeader } = state.currentSession.currentGame;
            let isFinalPhase = currentIsFinalPhase;
            
            let isFinished = false;

            if (condition === 'bestOf') {
                const totalTickets = players.reduce((sum, p) => sum + p.score, 0);
                if (totalTickets >= winningScore) {
                    isFinished = true;
                }
            } else {
                if (players.some(p => p.score >= winningScore)) {
                    if (!isFinalPhase) updates["currentGame.isFinalPhase"] = true;
                    isFinalPhase = true;
                }
                if (isFinalPhase && finalRoundMode) {
                    const scores = players.map(p => p.score);
                    const leaderScore = (condition === 'highest') ? Math.max(...scores) : Math.min(...scores);
                    const leaders = players.filter(p => p.score === leaderScore);
                    const uniqueLeaderId = leaders.length === 1 ? leaders[0].id : null;
                    updates["currentGame.potentialWinnerStreak"] = (uniqueLeaderId && uniqueLeaderId === currentLeader) ? currentStreak + 1 : 1;
                    updates["currentGame.lastRoundLeaderId"] = uniqueLeaderId;
                    if (updates["currentGame.potentialWinnerStreak"] >= 2 && uniqueLeaderId) isFinished = true;
                } else if (isFinalPhase) {
                    isFinished = true;
                }
            }
            
            if (isFinished) {
                updates["currentGame.isFinished"] = true;
            }

            if (Object.keys(updates).length > 0) {
                await updateSession(updates);
            }
        }

        async function triggerEndGame(title) {
            stopTimer();
            const { condition, gameId } = state.currentSession.currentGame;
            const players = [...state.currentSession.currentGame.players];
            players.sort((a,b) => (condition === 'highest' || condition === 'bestOf') ? b.score - a.score : a.score - b.score);
            const winnerScore = players[0].score;
            const winnerIds = players.filter(p => p.score === winnerScore).map(p => p.id);
            
            winnerIds.forEach(id => {
                state.sessionStats.totalWins[id] = (state.sessionStats.totalWins[id] || 0) + 1;
                if (!state.sessionStats.gameWins[gameId]) state.sessionStats.gameWins[gameId] = {};
                state.sessionStats.gameWins[gameId][id] = (state.sessionStats.gameWins[gameId][id] || 0) + 1;
            });
            
            const batch = writeBatch(db);
            const gameDataRef = doc(gamesCollection, gameId);
            winnerIds.forEach(id => batch.update(gameDataRef, {[`winCounts.${id}`]: increment(1)}));
            for(const player of players) {
                const playerRef = doc(playersCollection, player.id);
                batch.update(playerRef, { totalGamesPlayed: increment(1), totalWins: winnerIds.includes(player.id) ? increment(1) : increment(0) });
            }
            await batch.commit();
            
            endGameTitle.textContent = title;
            renderFinalScores(players, condition);
            gameScreen.classList.add('hidden');
            endGameModal.classList.remove('hidden');
        }

        async function updateSession(updates) {
            if (!state.currentSession) return;
            const sessionRef = doc(sessionsCollection, state.currentSession.id);
            await updateDoc(sessionRef, updates);
        }

        function startNewSession() {
            state.sessionStats = { totalWins: {}, gameWins: {} };
            renderSessionLeaderboard();
            showNotification("New session started!");
        }
        
        async function saveGame() {
            const name = gameNameInput.value.trim();
            const winningScore = parseInt(gameScoreInput.value, 10);
            if (!name || isNaN(winningScore) || winningScore <= 0) { showNotification('Please provide a valid name and score.', true); return; }
            const gameData = { name, winningScore, condition: gameConditionSelect.value, finalRoundMode: finalRoundModeCheckbox.checked, winCounts: {} };
            try { await addDoc(gamesCollection, gameData); gameNameInput.value = ''; gameScoreInput.value = ''; gameRulesInput.value = ''; } 
            catch (error) { showNotification('Error: Could not save game.', true); }
        }
        
        async function addPlayer() {
            const name = playerNameInput.value.trim();
            if (!name) return;
            try { await addDoc(playersCollection, { name, totalWins: 0, totalGamesPlayed: 0 }); playerNameInput.value = ''; } 
            catch (error) { showNotification('Error: Could not add player.', true); }
        }
        
        async function deleteGame(gameId) { await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/games`, gameId)); }
        async function deletePlayer(playerId) { await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/players`, playerId)); }

        async function analyzeGameRules() {
            const rules = gameRulesInput.value;
            if (!rules.trim()) { showNotification("Please paste some rules to analyze.", true); return; }
            analyzeLoader.classList.remove('hidden');
            analyzeRulesBtn.disabled = true;
            const prompt = `You are a board game expert. Analyze the following game rules and extract the game's name, the score needed to win, the winning condition (highest or lowest score wins), and whether a final round is triggered after the score is reached. Provide the response as a JSON object with the keys "gameName", "winningScore", "winningCondition" (either "highest" or "lowest"), and "finalRoundMode" (boolean). If a value cannot be determined, return null for that key. Game Rules: ${rules}`;
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { 
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "gameName": { "type": "STRING" },
                            "winningScore": { "type": "NUMBER" },
                            "winningCondition": { "type": "STRING" },
                            "finalRoundMode": { "type": "BOOLEAN" }
                        }
                    }
                }
            };
            const apiKey = "AIzaSyD2PehrrJxKs2EWNsgkSR3k4GUKNg_QFf4";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();
                if (result.candidates && result.candidates[0].content.parts[0].text) {
                    const data = JSON.parse(result.candidates[0].content.parts[0].text);
                    gameNameInput.value = data.gameName || '';
                    if (data.winningScore) {
                        gameScoreInput.value = Math.round(data.winningScore);
                    } else {
                        gameScoreInput.value = '';
                    }
                    if (data.winningCondition === 'highest' || data.winningCondition === 'lowest') {
                        gameConditionSelect.value = data.winningCondition;
                    }
                    finalRoundModeCheckbox.checked = data.finalRoundMode || false;
                    showNotification("Rules analyzed successfully!");
                } else {
                    throw new Error("Invalid response from AI.");
                }
            } catch (error) {
                console.error("Error analyzing rules:", error);
                showNotification("Could not analyze rules. Please try again or enter manually.", true);
            } finally {
                analyzeLoader.classList.add('hidden');
                analyzeRulesBtn.disabled = false;
            }
        }

        function startGame() {
            const selectedGameId = lobbyGameSelect.value;
            const selectedPlayerIds = state.lobbySelectedPlayerIds;
            if (!selectedGameId || selectedPlayerIds.length < 1) { showNotification("Please select a game and at least one player.", true); return; }
            const gameToPlay = state.games.find(g => g.id === selectedGameId);
            localStorage.setItem('lastPlayedGameId', selectedGameId);
            const initialGameState = {
                gameId: gameToPlay.id,
                name: gameToPlay.name,
                winningScore: gameToPlay.winningScore,
                condition: gameToPlay.condition,
                finalRoundMode: gameToPlay.finalRoundMode,
                round: 1, 
                startTime: Date.now(),
                players: selectedPlayerIds.map(id => ({ id, score: 0, roundScores: {} })),
                isFinalPhase: false, isFinished: false,
                potentialWinnerStreak: 0, lastRoundLeaderId: null,
            };
            updateSession({ currentGame: initialGameState });
        }
        
        function renderFinalScores(players, condition) {
            finalScores.innerHTML = '';
            const winnerScore = players[0].score;
            players.forEach(player => {
                const playerInfo = state.players.find(p => p.id === player.id);
                if (!playerInfo) return;
                const p = document.createElement('p');
                p.className = 'text-lg p-2 rounded-md';
                let highlightClass = '';
                if ((condition === 'highest' || condition === 'bestOf') && player.score === winnerScore) highlightClass = 'bg-green-500 text-white font-bold';
                else if (condition === 'lowest') {
                    if (player.score === winnerScore) highlightClass = 'bg-green-500 text-white font-bold';
                    const maxScore = Math.max(...players.map(p => p.score));
                    if (player.score === maxScore && maxScore !== winnerScore) highlightClass = 'bg-red-500 text-white font-bold';
                }
                p.className += ` ${highlightClass}`;
                p.textContent = `${playerInfo.name}: ${player.score} points`;
                finalScores.appendChild(p);
            });
        }

        function startTimer() { if (state.timerInterval) clearInterval(state.timerInterval); state.timerInterval = setInterval(() => { const elapsed = Date.now() - state.startTime; const seconds = Math.floor((elapsed / 1000) % 60).toString().padStart(2, '0'); const minutes = Math.floor((elapsed / (1000 * 60)) % 60).toString().padStart(2, '0'); const hours = Math.floor((elapsed / (1000 * 60 * 60)) % 24).toString().padStart(2, '0'); timerDisplay.textContent = `${hours}:${minutes}:${seconds}`; }, 1000); }
        function stopTimer() { clearInterval(state.timerInterval); state.timerInterval = null; }

        function resetApp() {
            stopTimer();
            if (unsubscribeSession) { unsubscribeSession(); unsubscribeSession = null; }
            state.currentGame = null; state.gameState = null; state.currentSession = null;
            state.lobbySelectedPlayerIds = [];
            lobbyScreen.classList.add('hidden');
            gameScreen.classList.add('hidden');
            setupScreen.classList.remove('hidden');
        }

        function showNotification(message, isError = false, duration = 3000) {
            notification.textContent = message;
            notification.classList.toggle('bg-red-600', isError);
            notification.classList.toggle('bg-green-600', !isError);
            notification.classList.remove('opacity-0');
            setTimeout(() => {
                notification.classList.add('opacity-0');
            }, duration);
        }

        let draggedItem = null;
        let touchStartY = 0;
        function handleDragStart(e) { draggedItem = e.target; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', e.target.dataset.id); setTimeout(() => e.target.classList.add('dragging'), 0); }
        function handleDragEnd(e) { if(draggedItem) draggedItem.classList.remove('dragging'); document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); }
        function handleDragOver(e) { e.preventDefault(); const afterElement = getDragAfterElement(lobbySelectedPlayers, e.clientY); document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); if (afterElement) afterElement.classList.add('drag-over'); }
        function getDragAfterElement(container, y) { const draggableElements = [...container.querySelectorAll('.player-list-item:not(.dragging)')]; return draggableElements.reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = y - box.top - box.height / 2; if (offset < 0 && offset > closest.offset) { return { offset: offset, element: child }; } else { return closest; } }, { offset: Number.NEGATIVE_INFINITY }).element; }
        function handleDrop(e) { e.preventDefault(); if(!draggedItem) return; const id = draggedItem.dataset.id; const fromIndex = state.lobbySelectedPlayerIds.indexOf(id); const afterElement = getDragAfterElement(lobbySelectedPlayers, e.changedTouches ? e.changedTouches[0].clientY : e.clientY); const toIndex = afterElement ? state.lobbySelectedPlayerIds.indexOf(afterElement.dataset.id) : state.lobbySelectedPlayerIds.length; const item = state.lobbySelectedPlayerIds.splice(fromIndex, 1)[0]; state.lobbySelectedPlayerIds.splice(toIndex, 0, item); renderLobbyPlayerSelection(); }
        function handleTouchStart(e) { const target = e.target.closest('.player-list-item'); if (!target) return; draggedItem = target; touchStartY = e.touches[0].clientY; draggedItem.classList.add('dragging'); e.preventDefault();}
        function handleTouchMove(e) { if (!draggedItem) return; e.preventDefault(); const y = e.touches[0].clientY; draggedItem.style.transform = `translateY(${y - touchStartY}px)`; const afterElement = getDragAfterElement(lobbySelectedPlayers, y); document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); if (afterElement) afterElement.classList.add('drag-over');}
        function handleTouchEnd(e) { if (!draggedItem) return; draggedItem.classList.remove('dragging'); draggedItem.style.transform = ''; handleDrop(e); draggedItem = null;}

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service worker registered.', reg))
                    .catch(err => console.log('Service worker registration failed: ', err));
            });
        }
    </script>
</body>
</html>
